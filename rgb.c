/*
 * rgb.c
 *
 * Created: 12/25/2020 12:21:10 AM
 *  Author: Benjamin Hicks
 */

#include <avr/io.h>
#include <avr/interrupt.h>
#include <avr/pgmspace.h>
#include "rgb.h"

volatile uint8_t color_index = 0;
volatile uint32_t *color_table = 0;

void rgb_init(void)
{
	PORTD.OUTSET &= ~RED_bm & ~GREEN_bm & ~BLUE_bm;
	// invert the pins for wavegen purposes
	PORTD.PIN4CTRL = PORT_INVEN_bm;
	PORTD.PIN5CTRL = PORT_INVEN_bm;
	PORTD.PIN6CTRL = PORT_INVEN_bm;
	
	PORTD.DIRSET = RED_bm | GREEN_bm | BLUE_bm;
	PORTD.REMAP = PORT_TC0A_bm | PORT_TC0B_bm | PORT_TC0C_bm;
	
}

void rgb_tcd0_init(void)
{
	TCD0.CTRLA = TC_CLKSEL_OFF_gc;
	TCD0.CNT = 0;
	TCD0.PER = 0xFF;
	TCD0.INTCTRLA = TC_OVFINTLVL_LO_gc;
}

void rgb_play(uint32_t* colors)
{
	if (colors)
	{
		color_table = colors;
		color_index = 0;
		// enable waveform generation tools
		TCD0.CTRLB = TC0_CCAEN_bm | TC0_CCBEN_bm | TC0_CCCEN_bm | TC_WGMODE_SINGLESLOPE_gc;
		TCD0.CTRLA = TC_CLKSEL_DIV1024_gc;
	}
}

void rgb_stop(void)
{
	TCD0.CTRLA = TC_CLKSEL_OFF_gc;
	TCD0.CNT = 0;
	// disable waveform generation tools
	TCD0.CTRLB &= ~TC0_CCAEN_bm & ~TC0_CCBEN_bm & ~TC0_CCCEN_bm;
	PORTD.OUTCLR = RED_bm | GREEN_bm | BLUE_bm;
}

ISR(TCD0_OVF_vect)
{
	uint32_t color_value = pgm_read_dword(&color_table[color_index++]);
	TCD0.CCA = (uint16_t)((uint8_t)(color_value >> 0));
	TCD0.CCB = (uint16_t)((uint8_t)(color_value >> 8));
	TCD0.CCC = (uint16_t)((uint8_t)(color_value >> 16));
}

const uint32_t rainbow[256] PROGMEM = {
	0x0000ff,
	0x0000ff,
	0x0006ff,
	0x000cff,
	0x0012ff,
	0x0018ff,
	0x001eff,
	0x0024ff,
	0x002aff,
	0x0030ff,
	0x0036ff,
	0x003cff,
	0x0042ff,
	0x0048ff,
	0x004eff,
	0x0054ff,
	0x005aff,
	0x0060ff,
	0x0066ff,
	0x006cff,
	0x0072ff,
	0x0078ff,
	0x007eff,
	0x0084ff,
	0x008aff,
	0x0090ff,
	0x0096ff,
	0x009cff,
	0x00a2ff,
	0x00a8ff,
	0x00aeff,
	0x00b4ff,
	0x00baff,
	0x00c0ff,
	0x00c6ff,
	0x00ccff,
	0x00d2ff,
	0x00d8ff,
	0x00deff,
	0x00e4ff,
	0x00eaff,
	0x00f0ff,
	0x00f6ff,
	0x00ffff,
	0x00ffff,
	0x00fff9,
	0x00fff3,
	0x00ffed,
	0x00ffe7,
	0x00ffe1,
	0x00ffdb,
	0x00ffd5,
	0x00ffcf,
	0x00ffc9,
	0x00ffc3,
	0x00ffbd,
	0x00ffb7,
	0x00ffb1,
	0x00ffab,
	0x00ffa5,
	0x00ff9f,
	0x00ff99,
	0x00ff93,
	0x00ff8d,
	0x00ff87,
	0x00ff81,
	0x00ff7b,
	0x00ff75,
	0x00ff6f,
	0x00ff69,
	0x00ff63,
	0x00ff5d,
	0x00ff57,
	0x00ff51,
	0x00ff4b,
	0x00ff45,
	0x00ff3f,
	0x00ff39,
	0x00ff33,
	0x00ff2d,
	0x00ff27,
	0x00ff21,
	0x00ff1b,
	0x00ff15,
	0x00ff0f,
	0x00ff09,
	0x00ff00,
	0x06ff00,
	0x0cff00,
	0x12ff00,
	0x18ff00,
	0x1eff00,
	0x24ff00,
	0x2aff00,
	0x30ff00,
	0x36ff00,
	0x3cff00,
	0x42ff00,
	0x48ff00,
	0x4eff00,
	0x54ff00,
	0x5aff00,
	0x60ff00,
	0x66ff00,
	0x6cff00,
	0x72ff00,
	0x78ff00,
	0x7eff00,
	0x84ff00,
	0x8aff00,
	0x90ff00,
	0x96ff00,
	0x9cff00,
	0xa2ff00,
	0xa8ff00,
	0xaeff00,
	0xb4ff00,
	0xbaff00,
	0xc0ff00,
	0xc6ff00,
	0xccff00,
	0xd2ff00,
	0xd8ff00,
	0xdeff00,
	0xe4ff00,
	0xeaff00,
	0xf0ff00,
	0xf6ff00,
	0xffff00,
	0xffff00,
	0xfff900,
	0xfff300,
	0xffed00,
	0xffe700,
	0xffe100,
	0xffdb00,
	0xffd500,
	0xffcf00,
	0xffc900,
	0xffc300,
	0xffbd00,
	0xffb700,
	0xffb100,
	0xffab00,
	0xffa500,
	0xff9f00,
	0xff9900,
	0xff9300,
	0xff8d00,
	0xff8700,
	0xff8100,
	0xff7b00,
	0xff7500,
	0xff6f00,
	0xff6900,
	0xff6300,
	0xff5d00,
	0xff5700,
	0xff5100,
	0xff4b00,
	0xff4500,
	0xff3f00,
	0xff3900,
	0xff3300,
	0xff2d00,
	0xff2700,
	0xff2100,
	0xff1b00,
	0xff1500,
	0xff0f00,
	0xff0900,
	0xff0000,
	0xff0006,
	0xff000c,
	0xff0012,
	0xff0018,
	0xff001e,
	0xff0024,
	0xff002a,
	0xff0030,
	0xff0036,
	0xff003c,
	0xff0042,
	0xff0048,
	0xff004e,
	0xff0054,
	0xff005a,
	0xff0060,
	0xff0066,
	0xff006c,
	0xff0072,
	0xff0078,
	0xff007e,
	0xff0084,
	0xff008a,
	0xff0090,
	0xff0096,
	0xff009c,
	0xff00a2,
	0xff00a8,
	0xff00ae,
	0xff00b4,
	0xff00ba,
	0xff00c0,
	0xff00c6,
	0xff00cc,
	0xff00d2,
	0xff00d8,
	0xff00de,
	0xff00e4,
	0xff00ea,
	0xff00f0,
	0xff00f6,
	0xff00ff,
	0xff00ff,
	0xf900ff,
	0xf300ff,
	0xed00ff,
	0xe700ff,
	0xe100ff,
	0xdb00ff,
	0xd500ff,
	0xcf00ff,
	0xc900ff,
	0xc300ff,
	0xbd00ff,
	0xb700ff,
	0xb100ff,
	0xab00ff,
	0xa500ff,
	0x9f00ff,
	0x9900ff,
	0x9300ff,
	0x8d00ff,
	0x8700ff,
	0x8100ff,
	0x7b00ff,
	0x7500ff,
	0x6f00ff,
	0x6900ff,
	0x6300ff,
	0x5d00ff,
	0x5700ff,
	0x5100ff,
	0x4b00ff,
	0x4500ff,
	0x3f00ff,
	0x3900ff,
	0x3300ff,
	0x2d00ff,
	0x2700ff,
	0x2100ff,
	0x1b00ff,
	0x1500ff,
	0x0f00ff,
	0x0900ff
};

const uint32_t ocean_blue[256] PROGMEM = {
	0xff0000,
	0xff0200,
	0xff0400,
	0xff0600,
	0xff0800,
	0xff0a00,
	0xff0c00,
	0xff0e00,
	0xff1000,
	0xff1200,
	0xff1400,
	0xff1600,
	0xff1800,
	0xff1a00,
	0xff1c00,
	0xff1e00,
	0xff2000,
	0xff2200,
	0xff2400,
	0xff2600,
	0xff2800,
	0xff2a00,
	0xff2c00,
	0xff2e00,
	0xff3000,
	0xff3200,
	0xff3400,
	0xff3600,
	0xff3800,
	0xff3a00,
	0xff3c00,
	0xff3e00,
	0xff4000,
	0xff4200,
	0xff4400,
	0xff4600,
	0xff4800,
	0xff4a00,
	0xff4c00,
	0xff4e00,
	0xff5000,
	0xff5200,
	0xff5400,
	0xff5600,
	0xff5800,
	0xff5a00,
	0xff5c00,
	0xff5e00,
	0xff6000,
	0xff6200,
	0xff6400,
	0xff6600,
	0xff6800,
	0xff6a00,
	0xff6c00,
	0xff6e00,
	0xff7000,
	0xff7200,
	0xff7400,
	0xff7600,
	0xff7800,
	0xff7a00,
	0xff7c00,
	0xff7e00,
	0xff8000,
	0xff8200,
	0xff8400,
	0xff8600,
	0xff8800,
	0xff8a00,
	0xff8c00,
	0xff8e00,
	0xff9000,
	0xff9200,
	0xff9400,
	0xff9600,
	0xff9800,
	0xff9a00,
	0xff9c00,
	0xff9e00,
	0xffa000,
	0xffa200,
	0xffa400,
	0xffa600,
	0xffa800,
	0xffaa00,
	0xffac00,
	0xffae00,
	0xffb000,
	0xffb200,
	0xffb400,
	0xffb600,
	0xffb800,
	0xffba00,
	0xffbc00,
	0xffbe00,
	0xffc000,
	0xffc200,
	0xffc400,
	0xffc600,
	0xffc800,
	0xffca00,
	0xffcc00,
	0xffce00,
	0xffd000,
	0xffd200,
	0xffd400,
	0xffd600,
	0xffd800,
	0xffda00,
	0xffdc00,
	0xffde00,
	0xffe000,
	0xffe200,
	0xffe400,
	0xffe600,
	0xffe800,
	0xffea00,
	0xffec00,
	0xffee00,
	0xfff000,
	0xfff200,
	0xfff400,
	0xfff600,
	0xfff800,
	0xfffa00,
	0xfffc00,
	0xfffe00,
	0xffff00,
	0xfffd00,
	0xfffb00,
	0xfff900,
	0xfff700,
	0xfff500,
	0xfff300,
	0xfff100,
	0xffef00,
	0xffed00,
	0xffeb00,
	0xffe900,
	0xffe700,
	0xffe500,
	0xffe300,
	0xffe100,
	0xffdf00,
	0xffdd00,
	0xffdb00,
	0xffd900,
	0xffd700,
	0xffd500,
	0xffd300,
	0xffd100,
	0xffcf00,
	0xffcd00,
	0xffcb00,
	0xffc900,
	0xffc700,
	0xffc500,
	0xffc300,
	0xffc100,
	0xffbf00,
	0xffbd00,
	0xffbb00,
	0xffb900,
	0xffb700,
	0xffb500,
	0xffb300,
	0xffb100,
	0xffaf00,
	0xffad00,
	0xffab00,
	0xffa900,
	0xffa700,
	0xffa500,
	0xffa300,
	0xffa100,
	0xff9f00,
	0xff9d00,
	0xff9b00,
	0xff9900,
	0xff9700,
	0xff9500,
	0xff9300,
	0xff9100,
	0xff8f00,
	0xff8d00,
	0xff8b00,
	0xff8900,
	0xff8700,
	0xff8500,
	0xff8300,
	0xff8100,
	0xff7f00,
	0xff7d00,
	0xff7b00,
	0xff7900,
	0xff7700,
	0xff7500,
	0xff7300,
	0xff7100,
	0xff6f00,
	0xff6d00,
	0xff6b00,
	0xff6900,
	0xff6700,
	0xff6500,
	0xff6300,
	0xff6100,
	0xff5f00,
	0xff5d00,
	0xff5b00,
	0xff5900,
	0xff5700,
	0xff5500,
	0xff5300,
	0xff5100,
	0xff4f00,
	0xff4d00,
	0xff4b00,
	0xff4900,
	0xff4700,
	0xff4500,
	0xff4300,
	0xff4100,
	0xff3f00,
	0xff3d00,
	0xff3b00,
	0xff3900,
	0xff3700,
	0xff3500,
	0xff3300,
	0xff3100,
	0xff2f00,
	0xff2d00,
	0xff2b00,
	0xff2900,
	0xff2700,
	0xff2500,
	0xff2300,
	0xff2100,
	0xff1f00,
	0xff1d00,
	0xff1b00,
	0xff1900,
	0xff1700,
	0xff1500,
	0xff1300,
	0xff1100,
	0xff0f00,
	0xff0d00,
	0xff0b00,
	0xff0900,
	0xff0700,
	0xff0500,
	0xff0300,
	0xff0100,
};

const uint32_t flaming_red[256] PROGMEM = {
	0x0000ff,
	0x0001ff,
	0x0002ff,
	0x0003ff,
	0x0004ff,
	0x0005ff,
	0x0006ff,
	0x0007ff,
	0x0008ff,
	0x0009ff,
	0x000aff,
	0x000bff,
	0x000cff,
	0x000dff,
	0x000eff,
	0x000fff,
	0x0010ff,
	0x0011ff,
	0x0012ff,
	0x0013ff,
	0x0014ff,
	0x0015ff,
	0x0016ff,
	0x0017ff,
	0x0018ff,
	0x0019ff,
	0x001aff,
	0x001bff,
	0x001cff,
	0x001dff,
	0x001eff,
	0x001fff,
	0x0020ff,
	0x0021ff,
	0x0022ff,
	0x0023ff,
	0x0024ff,
	0x0025ff,
	0x0026ff,
	0x0027ff,
	0x0028ff,
	0x0029ff,
	0x002aff,
	0x002bff,
	0x002cff,
	0x002dff,
	0x002eff,
	0x002fff,
	0x0030ff,
	0x0031ff,
	0x0032ff,
	0x0033ff,
	0x0034ff,
	0x0035ff,
	0x0036ff,
	0x0037ff,
	0x0038ff,
	0x0039ff,
	0x003aff,
	0x003bff,
	0x003cff,
	0x003dff,
	0x003eff,
	0x003fff,
	0x0040ff,
	0x0041ff,
	0x0042ff,
	0x0043ff,
	0x0044ff,
	0x0045ff,
	0x0046ff,
	0x0047ff,
	0x0048ff,
	0x0049ff,
	0x004aff,
	0x004bff,
	0x004cff,
	0x004dff,
	0x004eff,
	0x004fff,
	0x0050ff,
	0x0051ff,
	0x0052ff,
	0x0053ff,
	0x0054ff,
	0x0055ff,
	0x0056ff,
	0x0057ff,
	0x0058ff,
	0x0059ff,
	0x005aff,
	0x005bff,
	0x005cff,
	0x005dff,
	0x005eff,
	0x005fff,
	0x0060ff,
	0x0061ff,
	0x0062ff,
	0x0063ff,
	0x0064ff,
	0x0065ff,
	0x0066ff,
	0x0067ff,
	0x0068ff,
	0x0069ff,
	0x006aff,
	0x006bff,
	0x006cff,
	0x006dff,
	0x006eff,
	0x006fff,
	0x0070ff,
	0x0071ff,
	0x0072ff,
	0x0073ff,
	0x0074ff,
	0x0075ff,
	0x0076ff,
	0x0077ff,
	0x0078ff,
	0x0079ff,
	0x007aff,
	0x007bff,
	0x007cff,
	0x007dff,
	0x007eff,
	0x007fff,
	0x0080ff,
	0x007fff,
	0x007eff,
	0x007dff,
	0x007cff,
	0x007bff,
	0x007aff,
	0x0079ff,
	0x0078ff,
	0x0077ff,
	0x0076ff,
	0x0075ff,
	0x0074ff,
	0x0073ff,
	0x0072ff,
	0x0071ff,
	0x0070ff,
	0x006fff,
	0x006eff,
	0x006dff,
	0x006cff,
	0x006bff,
	0x006aff,
	0x0069ff,
	0x0068ff,
	0x0067ff,
	0x0066ff,
	0x0065ff,
	0x0064ff,
	0x0063ff,
	0x0062ff,
	0x0061ff,
	0x0060ff,
	0x005fff,
	0x005eff,
	0x005dff,
	0x005cff,
	0x005bff,
	0x005aff,
	0x0059ff,
	0x0058ff,
	0x0057ff,
	0x0056ff,
	0x0055ff,
	0x0054ff,
	0x0053ff,
	0x0052ff,
	0x0051ff,
	0x0050ff,
	0x004fff,
	0x004eff,
	0x004dff,
	0x004cff,
	0x004bff,
	0x004aff,
	0x0049ff,
	0x0048ff,
	0x0047ff,
	0x0046ff,
	0x0045ff,
	0x0044ff,
	0x0043ff,
	0x0042ff,
	0x0041ff,
	0x0040ff,
	0x003fff,
	0x003eff,
	0x003dff,
	0x003cff,
	0x003bff,
	0x003aff,
	0x0039ff,
	0x0038ff,
	0x0037ff,
	0x0036ff,
	0x0035ff,
	0x0034ff,
	0x0033ff,
	0x0032ff,
	0x0031ff,
	0x0030ff,
	0x002fff,
	0x002eff,
	0x002dff,
	0x002cff,
	0x002bff,
	0x002aff,
	0x0029ff,
	0x0028ff,
	0x0027ff,
	0x0026ff,
	0x0025ff,
	0x0024ff,
	0x0023ff,
	0x0022ff,
	0x0021ff,
	0x0020ff,
	0x001fff,
	0x001eff,
	0x001dff,
	0x001cff,
	0x001bff,
	0x001aff,
	0x0019ff,
	0x0018ff,
	0x0017ff,
	0x0016ff,
	0x0015ff,
	0x0014ff,
	0x0013ff,
	0x0012ff,
	0x0011ff,
	0x0010ff,
	0x000fff,
	0x000eff,
	0x000dff,
	0x000cff,
	0x000bff,
	0x000aff,
	0x0009ff,
	0x0008ff,
	0x0007ff,
	0x0006ff,
	0x0005ff,
	0x0004ff,
	0x0003ff,
	0x0002ff,
	0x0001ff,
};

const uint32_t *color_patterns[COLOR_PATTERNS_COUNT] = { 0, rainbow, ocean_blue , flaming_red };